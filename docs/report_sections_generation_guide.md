# Report Sections Generation Guide

## Overview
This document explains how Report sections are created for the pbit folder structure used in pbi-tools during the migration from Cognos reports to Power BI.

## Source Data Flow

### 1. Cognos XML Report Structure
The source data comes from Cognos XML report files like `MaterialAdjustmentDetail_UC017.xml`. These XML files contain:

```xml
<report xmlns="http://developer.cognos.com/schemas/report/16.2/">
    <layouts>
        <layout>
            <reportPages>
                <page name="Page1" refQuery="MaterialAdjustmentDetail">
                    <pageBody>...</pageBody>
                    <pageHeader>...</pageHeader>
                </page>
            </reportPages>
        </layout>
    </layouts>
</report>
```

### 2. Parsing Process
The parsing happens in several stages:

#### Stage 1: XML Parsing (`cognos_migrator/report_parser.py`)
- `CognosReportSpecificationParser.parse_report_specification()` - Main entry point
- `_extract_pages_from_xml()` - Extracts page information from XML layouts
- Looks for `<layout>` and `<page>` elements in the XML
- Creates `ReportPage` objects with basic properties

```python
def _extract_pages_from_xml(self, root: ET.Element) -> List[ReportPage]:
    pages = []
    layouts = root.findall('.//layout') + root.findall('.//page')
    
    for i, layout in enumerate(layouts):
        page_name = layout.get('name', f'Page{i+1}')
        page = ReportPage(name=page_name, display_name=page_name)
        pages.append(page)
```

#### Stage 2: Report Structure Creation (`cognos_migrator/migrator.py`)
- `_create_report_structure_from_cognos()` - Creates Power BI report structure
- Converts Cognos pages to Power BI report pages
- Creates default page if none found

```python
def _create_report_structure_from_cognos(self, cognos_report, converted_data, data_model):
    page = ReportPage(
        name="Page1",
        display_name="Report Page",
        width=1280,
        height=720,
        visuals=[],
        filters=converted_data.get('filters', []),
        config={}
    )
```

### 3. File Generation Process

#### Stage 3: Section File Generation (`cognos_migrator/generators/report_file_generator.py`)
The actual section files are generated by `ReportFileGenerator._generate_report_sections()`:

```python
def _generate_report_sections(self, report: Report, report_dir: Path):
    sections_dir = report_dir / "sections"
    sections_dir.mkdir(exist_ok=True)
    
    for i, section in enumerate(report.sections):
        # Create section directory with format: 000_PageName
        section_dir_name = f"{i:03d}_{sanitized_name}"
        section_dir = sections_dir / section_dir_name
        section_dir.mkdir(exist_ok=True)
        
        # Generate three files in each section directory:
        # 1. section.json
        # 2. config.json  
        # 3. filters.json
```

## Generated File Structure

Each section creates this structure:
```
sections/
└── 000_Page1/
    ├── section.json    # Page metadata and layout
    ├── config.json     # Empty configuration object {}
    └── filters.json    # Empty filters array []
```

### File Contents

#### section.json
Generated from template `cognos_migrator/templates/report.section.json`:
```json
{
  "displayName": "Report Page",
  "displayOption": 1,
  "height": 720,
  "name": "063080c9cb5d49608964",  // Generated UUID
  "ordinal": 0,
  "width": 1280
}
```

#### config.json
Always empty for now:
```json
{}
```

#### filters.json
Always empty array for now:
```json
[]
```

## Template System

The generation uses a template engine (`cognos_migrator/generators/template_engine.py`) with templates in `cognos_migrator/templates/`:

- `report.section.json` - Template for section.json files
- `report.json` - Template for main report.json
- `report.config.json` - Template for report configuration

## Key Generation Components

### 1. PowerBIProjectOrchestrator (`cognos_migrator/generators/generators.py`)
- Orchestrates the entire generation process
- Calls report file generators
- Manages template rendering

### 2. ReportFileGenerator (`cognos_migrator/generators/report_file_generator.py`)
- Generates all report-related files
- Creates section directories and files
- Handles naming conventions and sanitization

### 3. Template Engine (`cognos_migrator/generators/template_engine.py`)
- Renders templates with context data
- Uses Pybars (Handlebars) templating system

## Current Limitations

1. **Static Content**: Currently generates mostly static/empty content
2. **Single Page**: Most reports create only one page by default
3. **No Visuals**: Visual containers are not yet generated
4. **No Filters**: Section-level filters are not extracted from Cognos

## Enhancement Opportunities

1. **Visual Extraction**: Parse Cognos visual elements (lists, charts, tables) and convert to Power BI visuals
2. **Filter Migration**: Extract and convert Cognos filters to Power BI filters
3. **Layout Preservation**: Maintain original layout structure where possible
4. **Multi-page Support**: Better handling of multi-page Cognos reports

## Related Files

- `/cognos_migrator/report_parser.py` - Main parsing logic
- `/cognos_migrator/generators/report_file_generator.py` - File generation
- `/cognos_migrator/templates/report.section.json` - Section template
- `/cognos_migrator/models.py` - Data structure definitions
- `/examples/Report XMLs DE/MaterialAdjustmentDetail_UC017.xml` - Source XML example

## Configuration

The generation process is controlled by:
- Template files in `/cognos_migrator/templates/`
- Generator classes in `/cognos_migrator/generators/`
- Model definitions in `/cognos_migrator/models.py` 